# just is a command runner, Justfile is very similar to Makefile, but simpler.

set shell := ['bash', '-euo', 'pipefail', '-c']

# Hostname for nix builds
hostname := `hostname -s`

# List all the just commands
default:
    @just --list

############################################################################
#
#  Chezmoi related commands
#
############################################################################

# Apply chezmoi changes
[group('chezmoi')]
apply:
    chezmoi apply

# Edit chezmoi managed files
[group('chezmoi')]
edit file:
    chezmoi edit {{ "{{file}}" }}

# Show chezmoi diff
[group('chezmoi')]
diff:
    chezmoi diff

# Update chezmoi and apply
[group('chezmoi')]
update:
    chezmoi update

# Re-add modified files to chezmoi
[group('chezmoi')]
re-add:
    chezmoi re-add
{{ if eq .platform "darwin" }}
############################################################################
#
#  Darwin related commands
#
############################################################################

# Build and switch nix-darwin configuration
[group('darwin')]
darwin:
    cd "$HOME/nix-config" && nix build .#darwinConfigurations.{{ "{{hostname}}" }}.system
    cd "$HOME/nix-config" && sudo ./result/sw/bin/darwin-rebuild switch --flake .#{{ "{{hostname}}" }}

# Build and switch with debug output
[group('darwin')]
darwin-debug:
    cd "$HOME/nix-config" && nix build .#darwinConfigurations.{{ "{{hostname}}" }}.system --show-trace --verbose
    cd "$HOME/nix-config" && sudo ./result/sw/bin/darwin-rebuild switch --flake .#{{ "{{hostname}}" }} --show-trace --verbose

# Check nix-darwin configuration without building
[group('darwin')]
darwin-check:
    cd "$HOME/nix-config" && nix flake check

# Build darwin configuration without switching
[group('darwin')]
darwin-build:
    cd "$HOME/nix-config" && nix build .#darwinConfigurations.{{ "{{hostname}}" }}.system
{{ end }}
############################################################################
#
#  Nix related commands
#
############################################################################

# Update all flake inputs
[group('nix')]
up:
    cd "$HOME/nix-config" && nix flake update

# Update specific flake input
[group('nix')]
upp input:
    cd "$HOME/nix-config" && nix flake update {{ "{{input}}" }}
{{ if eq .platform "darwin" }}
# List all generations of the system profile
[group('nix')]
history:
    nix profile history --profile /nix/var/nix/profiles/system
{{ end }}
# Open a nix repl with nixpkgs
[group('nix')]
repl:
    nix repl -f flake:nixpkgs

# Format chezmoi source files with treefmt
[group('dev')]
fmt:
    cd "$HOME/.local/share/chezmoi" && nix run nixpkgs#treefmt
{{ if eq .platform "darwin" }}
# Remove all generations older than 7 days
[group('nix')]
clean days='7':
    sudo nix profile wipe-history --profile /nix/var/nix/profiles/system --older-than {{ "{{days}}" }}d
{{ end }}
# Garbage collect unused nix store entries
[group('nix')]
gc days='7':
    # Garbage collect system-wide
    sudo nix-collect-garbage --delete-older-than {{ "{{days}}" }}d
    # Garbage collect user
    nix-collect-garbage --delete-older-than {{ "{{days}}" }}d

# Verify all nix store entries
[group('nix')]
verify:
    nix store verify --all

# Repair corrupted nix store entries
[group('nix')]
repair *paths:
    nix store repair {{ "{{paths}}" }}

# Show all auto gc roots in the nix store
[group('nix')]
gcroot:
    eza -lag /nix/var/nix/gcroots/auto/ 2>/dev/null || ls -al /nix/var/nix/gcroots/auto/

# Optimize nix store (hard-link identical files)
[group('nix')]
optimize:
    nix store optimise

# Switch flakey-profile
[group('nix')]
switch:
    nix run ~/nix-config#{{ "{{hostname}}" }}.switch

############################################################################
#
#  Git related commands
#
############################################################################

# Git status
[group('git')]
st:
    git status

# Git diff
[group('git')]
gd:
    git diff

# Git log with graph
[group('git')]
gl:
    git log --oneline --graph --decorate -20

# Commit all changes with message
[group('git')]
cm message:
    git add -A && git commit -m "{{ "{{message}}" }}"

# Push to remote
[group('git')]
push:
    git push

# Pull from remote
[group('git')]
pull:
    git pull --rebase

############################################################################
#
#  Utility commands
#
############################################################################

# Show system info
[group('utils')]
info:
    @echo "Hostname: {{ "{{hostname}}" }}"
    @echo "OS: $(uname -s)"
    @echo "Arch: $(uname -m)"
    @nix --version
{{ if eq .platform "darwin" }}
    @darwin-rebuild --version 2>/dev/null || true
{{ end -}}
# Run pre-commit checks
[group('dev')]
check:
    pre-commit run --all-files
{{ if eq .platform "darwin" }}
# Update all (flake + chezmoi + homebrew)
[group('utils')]
update-all: up
    chezmoi update
    brew update && brew upgrade

# Full system upgrade (updates + rebuild + cleanup)
[group('utils')]
full-upgrade:
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 1/7: Updating nix flake inputs..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    cd "$HOME/nix-config" && nix flake update
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 2/7: Rebuilding nix-darwin..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    cd "$HOME/nix-config" && nix build .#darwinConfigurations.{{ "{{hostname}}" }}.system
    cd "$HOME/nix-config" && sudo ./result/sw/bin/darwin-rebuild switch --flake .#{{ "{{hostname}}" }}
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 3/7: Updating chezmoi..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    chezmoi update || true
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 4/7: Updating mise tools..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    mise upgrade || true
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 5/7: Updating sheldon plugins..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    sheldon lock --update || true
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 6/7: Updating homebrew..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    brew update && brew upgrade
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 7/7: Cleaning up..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    brew cleanup --prune=7
    @echo ""
    @echo "✓ Full upgrade complete!"

# Clean all (nix gc + brew cleanup)
[group('utils')]
clean-all: gc
    brew cleanup --prune=7
{{ else }}
# Update all (flake + chezmoi)
[group('utils')]
update-all: up
    chezmoi update

# Full system upgrade (updates + cleanup)
[group('utils')]
full-upgrade:
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 1/5: Updating nix flake inputs..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    cd "$HOME/nix-config" && nix flake update
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 2/5: Switching nix profile..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    nix run ~/nix-config#{{ "{{hostname}}" }}.switch
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 3/5: Updating chezmoi..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    chezmoi update || true
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 4/5: Updating mise tools..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    mise upgrade || true
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Step 5/5: Updating sheldon plugins..."
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    sheldon lock --update || true
    @echo ""
    @echo "✓ Full upgrade complete!"

# Clean all (nix gc)
[group('utils')]
clean-all: gc
{{ end }}
